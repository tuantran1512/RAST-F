
      MODULE Inc_Adjoint

      implicit none

      ! Adjoint flux parameters
#ifdef tuan_tr_test
      real(8),            allocatable   :: CR_Bot0                    (:)    
      real(8),            allocatable   :: CR_Top0                    (:)    
      real(8),            allocatable   :: BotFol_Bot0                    (:)    
      real(8), allocatable :: bk_BotFol_Bot(:)
      real(8), allocatable :: t_Fuel0      (:,:)
      real(8), allocatable :: t_Mod0       (:,:)
      real(8), allocatable :: d_Mod0       (:,:)

#endif
      
      real(8), allocatable :: init_tFuel       (:,:)
      real(8), allocatable :: init_tMod        (:,:)
      real(8), allocatable :: init_dMod        (:,:)
      real(8), allocatable :: init_CR_Bot      (:)
      real(8), allocatable :: init_CR_Top      (:)
      real(8)              :: init_ppm
      real(8), allocatable :: init_miXS_a_Xe35 (:,:,:)
      real(8), allocatable :: init_miXS_a_Sm49 (:,:,:)
      real(8), allocatable :: init_N_Xe35      (:,:)
      real(8), allocatable :: init_N_Sm49      (:,:)

      real(8) :: sumv0
      REAL(8), allocatable:: dnw0   (:,:,:)
      REAL(8), allocatable:: dnn0   (:,:,:)
      REAL(8), allocatable:: dnb0   (:,:,:)
      REAL(8), allocatable:: xsxea0 (:,:,:)
      REAL(8), allocatable:: xssma0 (:,:,:)
      REAL(8), allocatable:: rnxe0  (:,:)
      REAL(8), allocatable:: rnsm0  (:,:)

      real(8) :: rhoadj

      integer, parameter :: FBRHO_NONE = 0
      integer, parameter :: FBRHO_DC  = 2    ! Coolant density coeff.
      integer, parameter :: FBRHO_PC  = 3    ! Boron reactivity coeff.
      integer, parameter :: FBRHO_TF  = 4    ! Fuel temperature coeff.
      integer, parameter :: FBRHO_TC  = 5    ! Coolant temperature coeff.
      integer, parameter :: FBRHO_PM  = 8    ! Boron component of reactivity

      real(8), allocatable :: bk_amd(:,:,:)
      real(8), allocatable :: bk_afd(:,:,:)
      real(8), allocatable :: bk_af2d(:,:)
      real(8), allocatable :: bk_scatd(:,:)
      real(8), allocatable :: bk_ccwd(:,:,:)
      real(8), allocatable :: bk_cced(:,:,:)
      real(8), allocatable :: bk_ccnd(:,:,:)
      real(8), allocatable :: bk_ccsd(:,:,:)
      real(8), allocatable :: bk_ccbd(:,:,:)
      real(8), allocatable :: bk_cctd(:,:,:)
      real(8), allocatable :: bk_dnwd(:,:,:)
      real(8), allocatable :: bk_dnnd(:,:,:)
      real(8), allocatable :: bk_dnbd(:,:,:)
      real(8), allocatable :: bk_xsxead(:,:,:)
      real(8), allocatable :: bk_xssmad(:,:,:)
      real(8), allocatable :: bk_rnxed(:,:)
      real(8), allocatable :: bk_rnsmd(:,:)

      real(8)              :: bk_ppm
      real(8), allocatable :: bk_CR_Bot(:)
      real(8), allocatable :: bk_CR_Top(:)
      real(8), allocatable :: bk_tFuel(:,:)
      real(8), allocatable :: bk_tMod(:,:)
      real(8), allocatable :: bk_dMod(:,:)


      real(8) :: COEF_FB1(50)
      real(8) :: COEF_FB2(50)
      real(8) :: COEF_FB3(50)
      real(8) :: COEF_FB4(50)
      real(8) :: COEF_FB5(50)
      real(8) :: COEF_FB6(50)
      real(8) :: COEF_FL1(50)
      real(8) :: COEF_FL2(50)
      real(8) :: COEF_FL3(50)
      real(8) :: COEF_FL4(50)
      real(8) :: COEF_FL5(50)
      real(8) :: COEF_FL6(50)

      data COEF_FB1(1:50) &
      / 1.60635462D-04,-1.38439332D-08, 7.98924725D-13, &
       -1.85513110D-17, 1.47980673D-22, 5.49898335D-05, &
       -2.52893759D-09, 1.85637227D-14, 1.93204416D-18, &
       -3.32251465D-23,-2.14393397D-05, 3.35002734D-09, &
       -1.80865395D-13, 3.43755171D-18,-1.89824043D-23, &
        3.77791635D-06,-7.99261126D-10, 5.05008923D-14, &
       -1.10935696D-18, 7.48252378D-24,-2.48969804D-07, &
        6.06017325D-11,-4.11562514D-15, 9.60556534D-20, &
       -6.92151412D-25, 6.03232825D-06,-2.23661924D-09, &
        1.25219597D-13,-2.19303466D-18, 1.11438499D-23, &
       -5.95434661D-06, 3.64153586D-09,-2.51966080D-13, &
        5.32320195D-18,-3.44341092D-23, 2.44196900D-06, &
       -1.64361989D-09, 1.27876404D-13,-2.95909100D-18, &
        2.07825579D-23,-4.46070406D-07, 3.08723247D-10, &
       -2.56810851D-14, 6.28275057D-19,-4.63054878D-24, &
        3.01468195D-08,-2.10102869D-11, 1.82067939D-15, &
       -4.61994138D-20, 3.51520013D-25                /
      data COEF_FB2(1:50) &
      / 1.23813147D-03,-8.08494838D-08, 5.19547642D-12, &
       -1.24908342D-16, 9.99978253D-22, 2.25814886D-04, &
        2.11802634D-09,-1.17346145D-12, 4.33786045D-17, &
       -4.39188708D-22,-8.36414640D-05, 8.45852561D-09, &
       -2.33532701D-13,-4.22764787D-19, 4.74996286D-23, &
        1.40143031D-05,-2.13963357D-09, 1.02924448D-13, &
       -1.60891583D-18, 5.35771957D-24,-8.83547800D-07, &
        1.59100811D-10,-8.92587191D-15, 1.71609464D-19, &
       -9.29181807D-25, 1.55637063D-05,-7.93307268D-09, &
        4.32148633D-13,-7.02765869D-18, 3.01650127D-23, &
       -1.77346866D-05, 1.25501661D-08,-8.63132014D-13, &
        1.76716804D-17,-1.08720623D-22, 6.26779981D-06, &
       -5.24622113D-09, 4.13383851D-13,-9.35587362D-18, &
        6.31585251D-23,-1.01311594D-06, 9.20444010D-10, &
       -7.88963709D-14, 1.90273606D-18,-1.35630639D-23, &
        6.16169284D-08,-5.89928501D-11, 5.34993555D-15, &
       -1.34779863D-19, 9.96679075D-25                /
      data COEF_FB3(1:50) &
      / 9.94886124D-04,-5.80205251D-09,-1.34337166D-12, &
        5.45704892D-17,-5.28080966D-22, 4.52617880D-04, &
       -1.14818709D-07, 8.71466495D-12,-2.25750129D-16, &
        1.84363118D-21,-2.01851127D-04, 6.95707636D-08, &
       -5.38160682D-12, 1.39471243D-16,-1.13821805D-21, &
        3.94839183D-05,-1.53714474D-08, 1.21744639D-12, &
       -3.18937478D-17, 2.62060710D-22,-2.83451944D-06, &
        1.17633758D-09,-9.46495845D-14, 2.50162179D-18, &
       -2.06837245D-23, 4.84422509D-05,-2.71352006D-08, &
        2.02815907D-12,-5.00324922D-17, 3.92742891D-22, &
       -7.25128190D-05, 4.09667160D-08,-3.23698843D-12, &
        8.17399980D-17,-6.49090813D-22, 3.42262236D-05, &
       -1.98404099D-08, 1.63815003D-12,-4.24952965D-17, &
        3.43059073D-22,-6.99074109D-06, 4.05382494D-09, &
       -3.42583713D-13, 9.05100984D-18,-7.40140974D-23, &
        5.17713622D-07,-2.98721349D-10, 2.55578765D-14, &
       -6.83295894D-19, 5.63969285D-24                /
      data COEF_FB4(1:50) &
      / 2.82955164D-03,-4.06218484D-07, 2.95056551D-11, &
       -7.49415410D-16, 6.13647230D-21,-1.72479154D-04, &
        3.23106208D-07,-2.82981018D-11, 7.75938985D-16, &
       -6.63293715D-21, 1.56412133D-04,-1.43640041D-07, &
        1.26154084D-11,-3.48754589D-16, 3.00288579D-21, &
       -4.22908530D-05, 3.01244935D-08,-2.59309034D-12, &
        7.11748418D-17,-6.10894281D-22, 3.65573743D-06, &
       -2.31776387D-09, 1.96354431D-13,-5.34668338D-18, &
        4.56653670D-23,-8.49255900D-05, 3.14560245D-08, &
       -3.00568593D-12, 8.94516223D-17,-8.08690247D-22, &
        1.13632639D-04,-4.44775692D-08, 3.92563774D-12, &
       -1.15412505D-16, 1.04688659D-21,-6.49960877D-05, &
        2.56862582D-08,-2.09591167D-12, 5.89753226D-17, &
       -5.23879669D-22, 1.47505316D-05,-6.00500446D-09, &
        4.74667824D-13,-1.29711902D-17, 1.13075558D-22, &
       -1.16599307D-06, 4.86505775D-10,-3.79968479D-14, &
        1.02073921D-18,-8.77916259D-24                /
      data COEF_FB5(1:50) &
      / 9.50446309D-04,-6.60525395D-08, 4.13476170D-12, &
       -9.62952581D-17, 7.47450930D-22, 7.14902360D-05, &
        1.47302405D-08,-1.49679725D-12, 4.22894120D-17, &
       -3.69912120D-22,-2.80533179D-05,-2.80464816D-10, &
        1.79108240D-13,-6.76500909D-18, 7.01502027D-23, &
        4.48446851D-06,-2.77578669D-10, 8.78512021D-16, &
        2.87752771D-19,-4.83082359D-24,-2.64594543D-07, &
        2.51211187D-11,-1.05372819D-15, 1.35081213D-20, &
        2.23736480D-26,-1.29567725D-05,-3.85488198D-09, &
        2.29741252D-13,-4.20929967D-18, 2.27613417D-23, &
       -6.92583851D-06, 5.87805062D-09,-4.32301598D-13, &
        9.47791970D-18,-6.34316021D-23, 1.80053303D-06, &
       -2.24308960D-09, 1.93442808D-13,-4.66873941D-18, &
        3.36135266D-23,-1.72288933D-07, 3.58456000D-10, &
       -3.48543329D-14, 9.01637891D-19,-6.82164106D-24, &
        3.52745932D-09,-2.09676162D-11, 2.25046192D-15, &
       -6.14154032D-20, 4.82310652D-25                /
      data COEF_FB6(1:50) &
      / 3.47811582D-04,-2.63917724D-08, 1.71413655D-12, &
       -4.09094060D-17, 3.22515992D-22, 6.98688503D-06, &
        1.19187055D-08,-1.04316561D-12, 2.82691310D-17, &
       -2.40524655D-22,-1.17408064D-06,-3.66296155D-09, &
        3.40758779D-13,-9.60530474D-18, 8.42572500D-23, &
       -2.15823565D-07, 6.69157889D-10,-6.00718385D-14, &
        1.67848845D-18,-1.47284967D-23, 4.10858635D-08, &
       -4.98129903D-11, 4.27549955D-15,-1.16952898D-19, &
        1.01464468D-24,-6.37105809D-06,-2.53266293D-10, &
       -8.39151181D-15, 8.73205374D-19,-1.15298646D-23, &
        7.99605860D-07, 4.89404186D-10,-2.36648482D-14, &
       -6.92128628D-20, 6.02953397D-24,-9.89777240D-07, &
       -5.30819725D-13, 3.61729352D-15, 7.01538447D-20, &
       -2.46378828D-24, 2.86854359D-07,-4.16670395D-11, &
        1.44852170D-15,-4.74324015D-20, 6.43772449D-25, &
       -2.54421823D-08, 5.45056747D-12,-2.55460606D-16, &
        6.24008612D-21,-6.27516431D-26                /
      data COEF_FL1(1:50) &
      / 1.26331613D-02, 5.00546517D-08,-3.18298369D-12, &
        7.68304502D-17,-6.19479830D-22,-1.31179584D-04, &
       -5.21063619D-09, 9.39227851D-13,-3.14812594D-17, &
        3.08777390D-22, 4.67648705D-05,-3.78166194D-09, &
        7.13560059D-14, 1.69521002D-18,-4.02362425D-23, &
       -7.74261156D-06, 1.11712133D-09,-5.59500696D-14, &
        9.01534481D-19,-2.83196497D-24, 4.84225641D-07, &
       -8.78314979D-11, 5.34797763D-15,-1.10569891D-19, &
        6.40621920D-25,-1.75685938D-05, 4.35013308D-09, &
       -2.07261983D-13, 2.45363064D-18,-9.49606470D-25, &
        8.93758531D-06,-7.73408018D-09, 5.21590498D-13, &
       -1.01438323D-17, 5.71395053D-23,-3.18975850D-06, &
        3.41011307D-09,-2.69465829D-13, 5.99823674D-18, &
       -3.93268432D-23, 5.19921972D-07,-6.19366872D-10, &
        5.37174428D-14,-1.29108128D-18, 9.11138202D-24, &
       -3.14718172D-08, 4.06917080D-11,-3.75196864D-15, &
        9.48225948D-20,-7.00483660D-25                /
      data COEF_FL2(1:50) &
      / 3.06294027D-02,-5.92640920D-08, 3.60402895D-12, &
       -8.39366088D-17, 6.56959259D-22, 4.55396816D-05, &
        1.76095856D-08,-1.55834339D-12, 4.27374101D-17, &
       -3.73103975D-22,-1.94491461D-05,-1.51796325D-09, &
        2.26299152D-13,-7.58931057D-18, 7.67899227D-23, &
        3.32372472D-06,-1.39027101D-10,-3.40123020D-15, &
        3.49853521D-19,-5.40810088D-24,-2.07510180D-07, &
        2.16572028D-11,-1.12237691D-15, 1.74466553D-20, &
       -9.16165144D-28,-5.50024404D-06,-3.49844719D-09, &
        1.73720163D-13,-2.30001051D-18, 4.40787957D-24, &
       -8.13676558D-06, 6.17518696D-09,-4.23172100D-13, &
        8.53609261D-18,-5.10264816D-23, 2.91750931D-06, &
       -2.67271287D-09, 2.13724289D-13,-4.88125108D-18, &
        3.31433966D-23,-4.53932322D-07, 4.75598795D-10, &
       -4.17970207D-14, 1.02663340D-18,-7.44059322D-24, &
        2.61397759D-08,-3.06423944D-11, 2.87211004D-15, &
       -7.40701286D-20, 5.59720040D-25                /
      data COEF_FL3(1:50) &
      / 0.11672910D+0 , 2.69749972D-06,-1.92143093D-10, &
        4.88150629D-15,-4.02040760D-20,-1.23078251D-03, &
       -1.72000062D-06, 1.59130384D-10,-4.48211108D-15, &
        3.91586075D-20,-3.49930024D-05, 6.67394794D-07, &
       -6.32115069D-11, 1.81762079D-15,-1.61482572D-20, &
        8.12556657D-05,-1.32586394D-07, 1.21831186D-11, &
       -3.47258459D-16, 3.07849774D-21,-9.65976923D-06, &
        1.00197516D-08,-8.93331511D-13, 2.51039456D-17, &
       -2.20793235D-22,-1.05186897D-04,-1.02857607D-07, &
        1.35230233D-11,-4.65480545D-16, 4.56185752D-21, &
       -4.14466671D-04, 1.04162548D-07,-1.25384277D-11, &
        4.64123748D-16,-4.83086716D-21, 2.56142830D-04, &
       -7.07355991D-08, 6.29677592D-12,-2.10189843D-16, &
        2.13487671D-21,-6.00266044D-05, 1.87128712D-08, &
       -1.47395971D-12, 4.46678391D-17,-4.33564868D-22, &
        4.84204134D-06,-1.64017252D-09, 1.23606731D-13, &
       -3.52347869D-18, 3.28640731D-23                /
      data COEF_FL4(1:50) &
      / 0.31269391D+00, 4.76727811D-06,-3.36732842D-10, &
        8.51454815D-15,-6.99431468D-20,-2.87354095D-03, &
       -2.88999600D-06, 2.69103340D-10,-7.58802336D-15, &
        6.63685179D-20, 1.90685641D-04, 1.09617860D-06, &
       -1.04735156D-10, 3.02049147D-15,-2.69116254D-20, &
        1.00998641D-04,-2.17283287D-07, 2.00456417D-11, &
       -5.72223080D-16, 5.08569422D-21,-1.43756102D-05, &
        1.64969909D-08,-1.46986000D-12, 4.12773787D-17, &
       -3.63537369D-22,-3.07177644D-04,-1.47798036D-07, &
        2.12264995D-11,-7.54355731D-16, 7.51208692D-21, &
       -6.79002063D-04, 1.33247766D-07,-1.78189615D-11, &
        7.06918853D-16,-7.61980784D-21, 4.31510070D-04, &
       -1.01807264D-07, 8.99753905D-12,-3.13746040D-16, &
        3.29631175D-21,-1.02368678D-04, 2.86521533D-08, &
       -2.17932967D-12, 6.70757007D-17,-6.66522271D-22, &
        8.32098242D-06,-2.59572943D-09, 1.88280634D-13, &
       -5.36751673D-18, 5.07543919D-23                /
      data COEF_FL5(1:50) &
      / 1.17502310D+00,-3.61271014D-06, 2.07959568D-10, &
       -4.61052930D-15, 3.45334004D-20,-4.25472612D-03, &
        1.74964105D-06,-1.18096835D-10, 2.78989860D-15, &
       -2.17038662D-20, 1.05872805D-03,-4.39652273D-07, &
        3.04244808D-11,-7.25193330D-16, 5.69251601D-21, &
       -1.55428402D-04, 5.89014875D-08,-3.94158561D-12, &
        9.13163254D-17,-7.04865780D-22, 9.39526311D-06, &
       -3.29824260D-09, 2.09701744D-13,-4.62505854D-18, &
        3.43848914D-23,-2.05447648D-03,-1.27392556D-07, &
        7.55911475D-12,-1.44185315D-16, 8.49676909D-22, &
       -4.11865147D-04, 2.12426841D-07,-1.55177466D-11, &
        3.58014128D-16,-2.57179737D-21, 1.58643451D-04, &
       -8.84209751D-08, 7.31818966D-12,-1.84117598D-16, &
        1.41399758D-21,-2.46414706D-05, 1.50988969D-08, &
       -1.35999403D-12, 3.62307420D-17,-2.90314816D-22, &
        1.41850603D-06,-9.35232188D-10, 8.96575848D-14, &
       -2.48946641D-18, 2.05634488D-23                /
      data COEF_FL6(1:50) &
      / 3.06748740D+00,-4.39657946D-05, 2.64624110D-09, &
       -6.12922688D-14, 4.78772550D-19, 5.21615411D-02, &
        9.82663540D-06,-9.41381691D-10, 2.65534674D-14, &
       -2.37218302D-19,-2.13017272D-02, 6.68719375D-07, &
        3.97879409D-11,-2.46712733D-15, 3.22291812D-20, &
        3.66490823D-03,-4.71725998D-07, 2.51663497D-11, &
       -4.43524747D-16, 1.59097403D-21,-2.32546192D-04, &
        4.25013588D-08,-2.88682527D-12, 6.62044481D-17, &
       -4.31568310D-22,-9.88688897D-04,-3.30568300D-06, &
        1.77324751D-10,-2.80907193D-15, 1.13020469D-20, &
       -7.62873325D-03, 5.64812766D-06,-3.95590873D-10, &
        8.28696350D-15,-5.25224099D-20, 2.83829633D-03, &
       -2.47182593D-06, 1.99102172D-10,-4.64077540D-15, &
        3.24887853D-20,-4.63701893D-04, 4.46834901D-07, &
       -3.91793195D-11, 9.74339873D-16,-7.20941281D-21, &
        2.81262629D-05,-2.92611214D-08, 2.71535695D-12, &
       -7.05420024D-17, 5.41361246D-22                /

      real(8) :: COEF_TYPEF(20)
      data COEF_TYPEF(1:20) &
      / 15.577D0,16.212D0,15.758D0,15.578D0,15.428D0, &
        16.326D0,15.064D0,15.577D0,15.577D0,15.577D0, &
        15.577D0,15.577D0,15.577D0,15.577D0,15.577D0, &
        15.577D0,15.577D0,15.577D0,15.577D0,15.577D0 /

      END MODULE Inc_Adjoint
